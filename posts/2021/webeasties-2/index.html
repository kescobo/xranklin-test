<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="author" content="Kevin S. Bonham">
  <meta name="description" content="Senior Research Scientist">

  <meta name="theme-color" content="#2962ff">

  <link
  rel=preconnect
  href="https://fonts.gstatic.com"
  crossorigin=anonymous>

<link
  rel=stylesheet
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"  crossorigin=anonymous>

<link
  rel=stylesheet
  href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"
  crossorigin=anonymous>

<link
  rel=stylesheet
  href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css"
  crossorigin=anonymous>

<link
  rel=stylesheet
  href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"
  crossorigin=anonymous>

<!-- locally served -->
<link rel=stylesheet href="/libs/academic/academic.min.css">

<link rel=stylesheet href="/css/extra.css">
<link rel=stylesheet href="/css/custom.css">

<!-- highlight + katex + plotly -->
<link rel=stylesheet href="/libs/highlight/atom-one-dark.css">





  <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script>

   <title>We, Beasties recovery - Part 2</title>  
</head>

<body id=top data-spy="scroll" data-offset="70" data-target=#navbar-main>

  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main>
  <div class=container>
    <!-- Main name -->
    <div class="d-none d-lg-inline-flex">
      <a class=navbar-brand href="/">K. Bonham</a>
    </div>
    <!-- Button for narrow mode -->
    <button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
      <span><i class="fas fa-bars"></i></span>
    </button>
    <!-- Main name for mobile mode -->
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class=navbar-brand href="/">K. Bonham</a>
    </div>
    <!-- Menu items -->
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content>
      <ul class="navbar-nav d-md-inline-flex">
        <li class=nav-item><a class=nav-link href="/#posts" data-target=#posts><span>Recent posts</span></a></li>
        <li class=nav-item><a class=nav-link href="/posts/"><span>Blog</span></a></li>
        <li class=nav-item><a class=nav-link href="/courses/"><span>Courses</span></a></li>
        <li class=nav-item><a class=nav-link href="/research/"><span>Research</span></a></li>
      </ul>
    </div>
  </div>
</nav>


  <span class="js-widget-page d-none"></span>

  
    <article class=article>
      <div class="article-container pt-3">
        <h1>We, Beasties recovery - Part 2</h1>
      </div>
      

      <div class="article-container">
        <div class="article-style">
  
<div class="franklin-content">
<p>Hey, it only took me 2 years to <a href="/posts/2020/webeasties-1">get back to this</a>&#33; Let&#39;s jump right in.</p>
<h2 id="previously"><a href="#previously" class="header-anchor">Previously...</a></h2>
<p>At the end of the last post, I had downloaded all of the html files from my <a href="https://scienceblogs.com/webeasties">old blog, <em>We, Beasties</em></a>, and pulled out the titles, dates, content &#40;including links&#41;, and tags.</p>
<p>Now, I&#39;d like to parse those and &#40;crudely&#41; turn them into markdown that can be built by <a href="http://franklinjl.org"><code>Franklin.jl</code></a>.</p>
<h2 id="converting_html_to_markdown"><a href="#converting_html_to_markdown" class="header-anchor">Converting html to markdown</a></h2>
<p>I already figured out how to get all of the elements out of the HTML, now it&#39;s just a matter of making them into markdown.</p>
<p>Let&#39;s review</p>
<pre><code class="language-julia">projectdir &#61; joinpath&#40;pwd&#40;&#41;, &quot;_literate&quot;, &quot;webeasties&quot;&#41;
htmlout &#61; joinpath&#40;projectdir, &quot;html_out/&quot;&#41;</code></pre><pre><code class="plaintext code-output">AssertionError: sourcepath !== nothing
</code></pre>
<pre><code class="language-julia">using EzXML

function gettags&#40;body&#41;
    tags &#61; String&#91;&#93;
    tagnodes &#61; findall&#40;&quot;.//div&#91;@class&#61;\&quot;field--item\&quot;&#93;&quot;, body&#41;
    for tagnode in tagnodes
        a &#61; findfirst&#40;&quot;./a&#91;@href&#93;&quot;, tagnode&#41;
        link &#61; first&#40;attributes&#40;a&#41;&#41;.content
        m &#61; match&#40;r&quot;^/tag/&#40;&#91;\w\-&#93;&#43;&#41;&#36;&quot;, link&#41;
        isnothing&#40;m&#41; &amp;&amp; continue
        push&#33;&#40;tags, m.captures&#91;1&#93;&#41;
    end
    return tags
end

function getcontent&#40;path&#41;

    post &#61; readhtml&#40;path&#41;
    doc &#61; root&#40;post&#41;
    title &#61; findall&#40;&quot;//title&quot;, doc&#41; # could have done &#96;findfirst&#96; instead, but then couldn&#39;t check if it&#39;s unique
    length&#40;title&#41; &#33;&#61; 1 &amp;&amp; error&#40;&quot;Expected only 1 title block, got &#36;&#40;length&#40;title&#41;&#41; from &#36;p&quot;&#41;
    title &#61; first&#40;title&#41; |&gt; nodecontent # get it out of the array

    body &#61; findall&#40;&quot;//div&#91;@class&#61;\&quot;content\&quot;&#93;&quot;, doc&#41;
    length&#40;body&#41; &#33;&#61; 1 &amp;&amp; error&#40;&quot;Expected only 1 content block, got &#36;&#40;length&#40;body&#41;&#41; from &#36;path&quot;&#41;
    body &#61; first&#40;body&#41;

    tags &#61; gettags&#40;body&#41;
    content &#61; body.content
    links &#61; findall&#40;&quot;.//a&#91;@href&#93;&quot;, body&#41;
    imgs &#61; findall&#40;&quot;.//img&quot;, body&#41;

    return &#40;; path, content, title, post, links, tags, imgs&#41;
end</code></pre><pre><code class="plaintext code-output">ArgumentError: Package EzXML [8f5d6c58-4d21-5cfd-889c-e3ad7ee6a615] is required but does not seem to be installed:
 - Run `Pkg.instantiate()` to install all recorded dependencies.

</code></pre>
<pre><code class="language-julia">paths &#61; readdir&#40;htmlout, join&#61;true&#41;

stuff &#61; getcontent&#40;last&#40;paths&#41;&#41;
print&#40;first&#40;stuff.content, 1000&#41;, &quot;...&quot;&#41;</code></pre><pre><code class="plaintext code-output">SystemError: unable to read directory /home/runner/work/xranklin-test/xranklin-test/_literate/webeasties/html_out/: No such file or directory
</code></pre>
<pre><code class="language-julia">first&#40;stuff.links, 4&#41;</code></pre><pre><code class="plaintext code-output">UndefVarError: stuff not defined
</code></pre>
<pre><code class="language-julia">stuff.tags</code></pre><pre><code class="plaintext code-output">UndefVarError: stuff not defined
</code></pre>
<p>This the <a href="https://scienceblogs.com/webeasties/2013/09/03/we-beasties-sproulates">last post</a> I made on the blog in 2013. It&#39;s got some pictures and a bunch of links, but not much other formatting, so should be pretty straightforward.</p>
<p>The first thing I decided to tackle was how to deal with the links...</p>
<h3 id="link_nodes"><a href="#link_nodes" class="header-anchor">Link nodes</a></h3>
<p>Looking inside the contents of each element of <code>links</code>, it looks like all of the useful info I need is there:</p>
<pre><code class="language-julia">link &#61; stuff.links&#91;2&#93;
nodecontent&#40;link&#41;</code></pre><pre><code class="plaintext code-output">UndefVarError: stuff not defined
</code></pre>
<pre><code class="language-julia">nodecontent&#40;first&#40;attributes&#40;link&#41;&#41;&#41;</code></pre><pre><code class="plaintext code-output">UndefVarError: attributes not defined
</code></pre>
<p>So all I need to do to start building the markdown is to find the text inside <code>stuff.content</code>, and replace it with a markdown link. Eg, <code>Paul de Kruif&#39;s</code> will become <code>&#91;Paul de Kruif&#39;s&#93;&#40;http://www.amazon...&#41;</code>.</p>
<p>This is easily done with julia&#39;s <code>replace&#40;&#41;</code> function.</p>
<pre><code class="language-julia">function make_md_links&#40;content, links&#41;
    for lnk in links
        repstring &#61; nodecontent&#40;lnk&#41;
        link &#61; nodecontent&#40;first&#40;attributes&#40;lnk&#41;&#41;&#41;
        isempty&#40;repstring&#41; &amp;&amp; continue # first link doesn&#39;t have anything in it
        any&#40;ext -&gt; endswith&#40;link, ext&#41;, &#91;&quot;.png&quot;, &quot;.jpeg&quot;, &quot;.jpg&quot;&#93;&#41; &amp;&amp; continue # skip images
        content &#61; replace&#40;content, repstring&#61;&gt;
                                   string&#40;&quot;&#91;&quot;, repstring, &quot;&#93;&#40;&quot;, link, &quot;&#41;&quot;&#41;,
                                   count&#61;1&#41;
    end
    return content
end

linkified &#61; make_md_links&#40;stuff.content, stuff.links&#41;
print&#40;first&#40;linkified, 500&#41;, &quot;...&quot;&#41;</code></pre><pre><code class="plaintext code-output">UndefVarError: stuff not defined
</code></pre>
<p>Easy&#33;</p>
<p>Much harder is dealing with images. When I was blogging back then, I didn&#39;t understand the importance &#40;for accessibility&#41; of including link text, so most image links are going to have empty content.</p>
<p>But I don&#39;t really need to reproduce these posts exactly, so I settled on just downloading the images &#40;if they exist&#41; and putting them all at the end.</p>
<pre><code class="language-julia">function append_image_links&#40;content, links, imgs&#41;
    # don&#39;t proceed if there are no image links
    if isempty&#40;imgs&#41; &amp;&amp; &#33;any&#40;lnk-&gt; any&#40;ext -&gt; endswith&#40;nodecontent&#40;first&#40;attributes&#40;lnk&#41;&#41;&#41;, ext&#41;, &#91;&quot;.png&quot;, &quot;.jpeg&quot;, &quot;.jpg&quot;&#93;&#41;, links&#41;
        return content
    end

    content *&#61; string&#40;&quot;\n\n ## Post Images\n\n&quot;&#41;
    for lnk in links
        alttext &#61; nodecontent&#40;lnk&#41;
        link &#61; nodecontent&#40;first&#40;attributes&#40;lnk&#41;&#41;&#41;
        isempty&#40;alttext&#41; &amp;&amp; &#40;alttext &#61; string&#40;&quot;Image at &#36;link&quot;&#41;&#41;
        if any&#40;ext -&gt; endswith&#40;link, ext&#41;, &#91;&quot;.png&quot;, &quot;.jpeg&quot;, &quot;.jpg&quot;&#93;&#41;

            targetpath &#61; joinpath&#40;&quot;_assets&quot;, &quot;img&quot;, &quot;webeasties&quot;, basename&#40;link&#41;&#41;
            if &#33;isfile&#40;targetpath&#41; # skip if already downloaded
                try
                    download&#40;link, targetpath&#41;
                catch
                    @error &quot;Couldn&#39;t download &#36;link, skipping&quot;
                end
            end
            if &#33;isfile&#40;targetpath&#41;
                content *&#61; string&#40;&quot;- &quot;, &quot;&#33;&#91;&quot;, alttext, &quot;&#93;&#40;/&quot;, targetpath, &quot;&#41;\n&quot;&#41;
            else
                content *&#61; string&#40;&quot;- Missing image: &quot;, alttext, &quot; | &quot;, link, &quot;\n&quot;&#41;
            end
        end
    end

    for img in imgs
        link &#61; findall&#40;&quot;.//@src&quot;, img&#41; |&gt; first |&gt; nodecontent
        alttext &#61; findall&#40;&quot;.//@alt&quot;, img&#41;
        alttext &#61; isempty&#40;alttext&#41; ? &quot;image at &#36;link&quot; : alttext |&gt; first |&gt; nodecontent
        if startswith&#40;link, &quot;/files/&quot;&#41;
            targetpath &#61; joinpath&#40;&quot;_assets&quot;, &quot;img&quot;, &quot;webeasties&quot;, basename&#40;link&#41;&#41;

            if &#33;isfile&#40;targetpath&#41; # skip if already downloaded
                download&#40;string&#40;&quot;https://scienceblogs.com&quot;, link&#41;, targetpath&#41;
            end
            content *&#61; string&#40;&quot;- &quot;, &quot;&#33;&#91;&quot;, alttext, &quot;&#93;&#40;/&quot;, targetpath&#91;2:end&#93;, &quot;&#41;\n&quot;&#41;
        end

    end
    return content
end</code></pre><pre><code class="plaintext code-output">append_image_links (generic function with 1 method)</code></pre>
<pre><code class="language-julia">with_images &#61; append_image_links&#40;linkified, stuff.links, stuff.imgs&#41;

print&#40;last&#40;with_images, 300&#41;&#41;</code></pre><pre><code class="plaintext code-output">UndefVarError: stuff not defined
</code></pre>
<h2 id="saving_the_markdown"><a href="#saving_the_markdown" class="header-anchor">Saving the markdown</a></h2>
<p>Now I&#39;ve got the content, it&#39;s time to save it. For the purposed of this post, I&#39;ll stick it in a temporary directory, but eventually, I want it to go into <code>webeasties/</code> in the repository for this website so that I can build them with Franklin.</p>
<pre><code class="language-julia">mdoutput &#61; mktempdir&#40;&#41;

mdoutput &#61; &quot;webeasties&quot;
isdir&#40;mdoutput&#41; || mkdir&#40;mdoutput&#41;

for p in paths
    @info p
    post &#61; getcontent&#40;p&#41;
    post_text &#61; replace&#40;post.content, r&quot;&#40;\S&#41;\n&#40;\S&#41;&quot;&#61;&gt; s&quot;\1\n\n\2&quot;&#41; # replace stand-alone new lines with doubles
    post_text &#61; replace&#40;post_text, r&quot;\n&#43;\s&#123;4&#125;Tags\n.&#43;&#36;&quot;s&#61;&gt;&quot;&quot;&#41; # replace garbage at the end of each post
    post_text &#61; replace&#40;post_text, &#39;&#36;&#39;&#61;&gt; raw&quot;\&#36;&quot;&#41; # franklin doesn&#39;t like these
    post_text &#61; replace&#40;post_text, r&quot;^\s&#123;4,&#125;&quot;&#61;&gt; &quot;&quot;&#41; # remove leading spaces
    post_text &#61; replace&#40;post_text, r&quot;\n&#123;3,&#125;&quot;s&#61;&gt; &quot;\n\n&quot;&#41; # remove anything more than 3 newlines
    post_text &#61; make_md_links&#40;post_text, post.links&#41;
    post_text &#61; append_image_links&#40;post_text, post.links, post.imgs&#41;


    &#40;y, m, d, postfile&#41; &#61; match&#40;r&quot;^&#40;\d&#123;4&#125;&#41;&#40;\d&#123;2&#125;&#41;&#40;\d&#123;2&#125;&#41;_&#40;.&#43;&#41;&quot;, basename&#40;post.path&#41;&#41;.captures

    t &#61; replace&#40;post.title, r&quot; \| ScienceBlogs&#36;&quot;&#61;&gt;&quot;&quot;&#41;
    t &#61; replace&#40;t, &#39;&quot;&#39;&#61;&gt; &quot;&#39;&quot;&#41;
    outdir &#61; joinpath&#40;mdoutput, y&#41;
    isdir&#40;outdir&#41; || mkdir&#40;outdir&#41;

    open&#40;joinpath&#40;mdoutput, y, replace&#40;postfile, r&quot;html?&#36;&quot;&#61;&gt;&quot;md&quot;&#41;&#41;, &quot;w&quot;&#41; do io
        print&#40;io, &quot;&quot;&quot;
        &#43;&#43;&#43;
        title &#61; &quot;&#36;t&quot;
        pubdate &#61; Date&#40;&quot;&#36;y-&#36;m-&#36;d&quot;&#41;
        tags &#61; &#36;&#40;post.tags&#41;
        category &#61; &quot;webeasties&quot;
        &#43;&#43;&#43;

        _This post initially appeared on &#91;Science Blogs&#93;&#40;http://scienceblogs.com/webeasties&#41;_

        &#36;post_text
        &quot;&quot;&quot;&#41;
    end
end</code></pre><pre><code class="plaintext code-output">UndefVarError: paths not defined
</code></pre>
<p>And that&#39;s it&#33; You can now see the <a href="/webeasties">archive here</a></p>


</div> <!-- article style -->


<div class="container">
  <footer class="site-footer">
    <p class="powered-by">Built with <a href="https://franklinjl.org" target="_blank" rel="noopener">Franklin.jl</a> and the <a href="https://julialang.org" target="_blank" rel="noopener">Julia Programming Language</a>.

      <span class="float-right" aria-hidden="true">
        <a href="#" class="back-to-top">
          <span class="button_icon">
            <i class="fas fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>
    </p>
  </footer>
</div>
</div>
  </div> <!--article container -->
</article>


<!-- CONTENT ENDS HERE -->
    
     <script src="/libs/highlight/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>
 

  <script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>

  <script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script>

  <script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script>

  <script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script>

  <script src="/libs/academic/academic.min.js"></script>

  </body>
</html>
